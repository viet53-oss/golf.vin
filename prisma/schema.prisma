generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Player {
  id                 String          @id @default(uuid())
  name               String
  email              String?         @unique
  phone              String?
  address            String?
  city               String?
  state              String?
  zip                String?
  preferred_tee_box  String?
  birthday           String?
  year_joined        String?
  index              Float           @default(0)
  low_handicap_index Float?
  created_at         DateTime        @default(now())
  rounds             RoundPlayer[]
  manual_rounds      HandicapRound[]
  live_round_players LiveRoundPlayer[]

  @@map("players")
}

model Course {
  id         String      @id @default(uuid())
  name       String
  created_at DateTime    @default(now())
  tee_boxes  TeeBox[]
  holes      Hole[]
  rounds     Round[]
  live_rounds LiveRound[]

  @@map("courses")
}

model TeeBox {
  id                String           @id @default(uuid())
  course_id         String
  name              String
  rating            Float
  slope             Float
  created_at        DateTime         @default(now())
  course            Course           @relation(fields: [course_id], references: [id])
  round_players     RoundPlayer[]
  live_round_players LiveRoundPlayer[]
  
  yardages          Int[]            @default([])

  @@map("tee_boxes")
}

model Hole {
  id          String      @id @default(uuid())
  course_id   String
  hole_number Int
  par         Int
  difficulty  Int?
  course      Course      @relation(fields: [course_id], references: [id])
  scores      Score[]
  live_scores LiveScore[]

  @@map("holes")
}

model Round {
  id            String        @id @default(uuid())
  date          String // YYYY-MM-DD
  course_id     String
  name          String?       // Optional name for the round (e.g. "Sunday")
  is_tournament Boolean       @default(false)
  completed     Boolean       @default(false)
  is_live       Boolean       @default(false)
  created_at    DateTime      @default(now())
  course        Course        @relation(fields: [course_id], references: [id])
  players       RoundPlayer[]

  @@index([date])
  @@index([course_id])
  @@map("rounds")
}

model RoundPlayer {
  id                   String   @id @default(uuid())
  round_id             String
  player_id            String
  tee_box_id           String?
  tee_box_name         String?  // Snapshot of tee box name at time of round
  tee_box_par          Int?     // Snapshot of par at time of round
  tee_box_rating       Float?   // Snapshot of course rating at time of round
  tee_box_slope        Int?     // Snapshot of slope rating at time of round
  course_handicap      Int?     // Course handicap for this round (calculated from index and slope at time of round)
  gross_score          Int?     // Made optional to allow adding players without scores yet
  adjusted_gross_score Int?     // For net double bogey
  front_nine           Int?
  back_nine            Int?
  score_differential   Float?
  index_at_time        Float?
  index_after          Float?   // New: Resulting index after this round
  points               Float    @default(0)
  payout               Float    @default(0)
  in_pool              Boolean  @default(false)
  created_at           DateTime @default(now())
  round                Round    @relation(fields: [round_id], references: [id])
  player               Player   @relation(fields: [player_id], references: [id])
  tee_box              TeeBox?  @relation(fields: [tee_box_id], references: [id])
  scores               Score[]

  @@index([player_id])
  @@index([round_id])
  @@map("round_players")
}

model HandicapRound {
  id                 String   @id @default(uuid())
  player_id          String
  date_played        String
  score_differential Float
  gross_score        Int?     // Optional gross score if available
  created_at         DateTime @default(now())
  player             Player   @relation(fields: [player_id], references: [id])

  @@index([player_id])
  @@index([date_played])
  @@map("handicap_rounds")
}

model Score {
  id                  String      @id @default(uuid())
  round_player_id     String
  hole_id             String
  strokes             Int
  putts               Int?
  fairway_hit         Boolean?
  green_in_regulation Boolean?
  created_at          DateTime    @default(now())

  round_player        RoundPlayer @relation(fields: [round_player_id], references: [id])
  hole                Hole        @relation(fields: [hole_id], references: [id])

  @@map("scores")
}

model Photo {
  id          String   @id @default(uuid())
  url         String
  date        String   // YYYY-MM-DD
  caption     String?
  uploaded_at DateTime @default(now())

  @@map("photos")
}

model Event {
  id          String   @id @default(uuid())
  name        String
  date        String
  location    String?
  created_at  DateTime @default(now())

  @@map("events")
}

model MoneyEvent {
  id          String   @id @default(uuid())
  round_id    String
  player_id   String
  hole_number Int
  event_type  String   // 'birdie', 'eagle', 'skin', etc.
  amount      Float    // Dollar amount earned/lost
  created_at  DateTime @default(now())

  @@index([round_id])
  @@index([player_id])
  @@map("money_events")
}

// ============================================
// LIVE SCORING TABLES (Isolated from main rounds)
// ============================================

model LiveRound {
  id          String   @id @default(uuid())
  name        String
  date        String   // YYYY-MM-DD
  course_id   String
  course      Course   @relation(fields: [course_id], references: [id])
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  players     LiveRoundPlayer[]

  @@index([date])
  @@index([course_id])
  @@map("live_rounds")
}

model LiveRoundPlayer {
  id                String     @id @default(uuid())
  live_round_id     String
  live_round        LiveRound  @relation(fields: [live_round_id], references: [id], onDelete: Cascade)
  player_id         String
  player            Player     @relation(fields: [player_id], references: [id])
  tee_box_id        String
  tee_box           TeeBox     @relation(fields: [tee_box_id], references: [id])
  
  // Snapshot data at time of round creation
  tee_box_name      String
  tee_box_rating    Float
  tee_box_slope     Int
  tee_box_par       Int
  index_at_time     Float
  course_handicap   Int
  
  // Running totals (updated as holes are scored)
  gross_score       Int?
  front_nine        Int?
  back_nine         Int?
  
  scores            LiveScore[]

  @@index([live_round_id])
  @@index([player_id])
  @@map("live_round_players")
}

model LiveScore {
  id                  String          @id @default(uuid())
  live_round_player_id String
  live_round_player   LiveRoundPlayer @relation(fields: [live_round_player_id], references: [id], onDelete: Cascade)
  hole_id             String
  hole                Hole            @relation(fields: [hole_id], references: [id])
  strokes             Int

  @@index([live_round_player_id])
  @@map("live_scores")
}

